<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mysqlOrder">
   
   <!-- 주문 추가  -->
   <insert id="order_insert">
	INSERT INTO `order` 
	(detailnum, email, totalprice, sale, saleprice, payprice, reserves, address, pay)
	VALUES
	(#{detailnem}, #{email}, 
	/* 총 구매금액 total price*/
	(SELECT sum(totalprice) FROM order_detail WHERE detailnum=#{detailnum}),
	/* 이메일로 랭크 별 할인율 sale*/
	(SELECT case when RANK = "브론즈" then 5 
                             when RANK = "실버" then 10
		     when RANK = "골드" then 15
		     ELSE 1 END FROM member WHERE email = #{email}),
	/* 할인 금액  saleprice*/			    
	(SELECT TRUNCATE(sum(totalprice)*
	(SELECT case when RANK = "브론즈" then 5 
                             when RANK = "실버" then 10
		     when RANK = "골드" then 15
		     ELSE 1 END FROM member WHERE email = #{email})*
	0.01,0) FROM order_detail WHERE detailnum=#{detailnum}), 
	/* 결제금액  payprice*/			    
	(SELECT sum(totalprice)-(SELECT TRUNCATE(sum(totalprice)*
	(SELECT case when RANK = "브론즈" then 5 
                             when RANK = "실버" then 10
		     when RANK = "골드" then 15
		     ELSE 1 END FROM member WHERE email = #{email})*
	0.01,0) FROM order_detail WHERE detailnum=#{detailnum}) FROM order_detail WHERE detailnum=#{detailnum}), 
	/* 적립금 reserves */			    
	(SELECT TRUNCATE((sum(totalprice)-(SELECT TRUNCATE(sum(totalprice)*
	(SELECT case when RANK = "브론즈" then 5 
                             when RANK = "실버" then 10
		     when RANK = "골드" then 15
		     ELSE 1 END FROM member WHERE email = #{email})*
	0.01,0) FROM order_detail WHERE detailnum=#{detailnum}))*0.01,0) FROM order_detail WHERE detailnum=#{detailnum}), 
	/* 주소 assress */			    
	(IFNULL((SELECT address FROM member WHERE email = #{email}),#{address}))
	#{pay})
   </insert>
 

   <!-- 주문 적립금 조회 -->
   <select id="detail_reserves" resultType="int">
      SELECT SUM(reserves) FROM order_detail WHERE detailnum = #{detailnum} 
   </select>

   <!-- 주문 품목 삭제 -->
   <!-- 삭제해도 장바구니에는 존재함 -->
   <delete id="order_delete">   
       delete from order where ordernum = #{ordernum}
   </delete>
	
   <!-- 적립금 조회 -->
   <select id="reserves_list" resultType="int">
      SELECT reserves FROM member WHERE email = #{email}
   </select>

   <!-- 바로 구매 삭제 (초기화) -->
   <delete id="order_nowdelete">   
       delete from order where ordernum = #{ordernum}
   </delete>

   <!-- 장바구니 수량 변경 -->
   <update id="prod_update">
      update cart set 
      quantity = #{quantity}, totalprice = #{quantity}*(SELECT price FROM product WHERE prodnum = #{prodnum}) where cartnum = #{cartnum}
   </update>

   <!-- 주문 대기 상태로 변경 (1개 이상의 cartnum 선택시 배열으로 받아서 for문 이용하여 1개이상 수정-->
   <update id="prod_order">
     UPDATE cart SET result = 2 WHERE cartnum = #{cartnum}
   </update>



</mapper>